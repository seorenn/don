<html>
  <head>
    <script type="text/javascript" src="http://seorenn.github.io/js/jquery.min.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/exchg.js"></script>
  </head>
  <body>
    <div id="exchanges">
      <h2>Current Exchange Rates</h2>
      <ul id="exchanges_datas">
      </ul>
    </div>

    <div id="calculator">
      <h2>Exchange Rate Calculator</h2>
      <form id="editor">
        <input type="text" name="currency"/>
        <select id="unit" name="unit">
        </select>
        <button type="button" id="conversion_button">Add Conversion</button>
      </form>
      <ul id="results">
      </ul>
    </div>

    <script type="text/javascript">
     // load cache from cookie
     var cached_data = get_cookie('exchg');
     if (cached_data != undefined) {
       currencies_cache = JSON.parse(cached_data);
     }

     var target_currency = currencies[0]['name'];

     // build editor's currency data

     for (var i=0; i < currencies.length; i++) {
       var cur = currencies[i];
       if (cur['name'] == target_currency) continue;
       $('#unit').append('<option value="' + cur['name'] + '">' + cur['name'] + '</option>');
     }

     var refresh_currency = function(index) {
       console.log('Refreshing currency with index ' + index);
       if (index >= currencies.length) {
         console.log('Index out of range. finishing...');
         // save cache using cookie
         var json_data = JSON.stringify(currencies_cache);
         set_cookie('exchg', json_data, 60 * 60);
         return;
       }
       cur = currencies[index];
       if (cur['name'] == target_currency) {
         console.log('Index ' + index + ' is same with target_currency. Skipping...');
         refresh_currency(index+1);
         return;
       }

       exchg(cur['name'], target_currency, function(rate) {
         $('#exchanges_datas').append('<li>1 ' + cur['name'] + ' = ' + target_currency + ' ' + rate + '</li>');
         refresh_currency(index+1);
       });
     }

     var refresh = function() {
       $('#exchanges_datas').html('');
       refresh_currency(0);
     };

     var results = [];

     var add_conversion = function() {
     };

     $(document).ready(function() {
       refresh();
     });
    </script>
  </body>
</html>
