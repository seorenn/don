<html>
  <head>
    <script type="text/javascript" src="http://seorenn.github.io/js/jquery.min.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/exchg.js"></script>
  </head>
  <body>
    <div id="config">
      <form id="config-form">
      Target Currency
        <select id="config-target">
        </select>
        <button type="button" id="remove_cookie_button">Remove Cookie</button>
      </form>
    </div>
    <div id="exchanges">
      <h2>Current Exchange Rates</h2>
      <ul id="exchanges_datas">
      </ul>
    </div>

    <div id="calculator">
      <h2>Exchange Rate Calculator</h2>
      <form id="editor" onsubmit="return false">
        <span class="calculator_text">Convert</span>
        <input type="text" name="currency" id="currency_input"/>
        <select id="unit" name="unit">
        </select>
        <span class="calculator_text" id="postfix_calculator"></span>
        <button type="button" id="conversion_button">Add Conversion</button>
      </form>
      <ul id="results">
      </ul>
    </div>

    <script type="text/javascript">
     var point_round_2 = function(value) {
       return Math.round(value * 100) / 100;
     };

     // load cache from cookie
     var refresh_cache = function() {
       var cached_data = get_cookie('exchg');
       if (cached_data != undefined) {
         currencies_cache = JSON.parse(cached_data);
       }
     }

     var target_currency = currencies[0]['name'];

     // build editor's currency data
     var selecting_target_index = -1;

     var update_editor_select_box = function(build_all) {
       if (build_all) {
         $('#config-target').html('');
       }

       // Build currencies select box for target and calculator
       for (var i=0; i < currencies.length; i++) {
         var cur = currencies[i];

         if (build_all) {
           $('#config-target').append('<option value="' + cur['name'] + '">' + cur['name'] + '</option>');
         }

         if (cur['name'] == target_currency) {
           selecting_target_index = i;
           continue;
         }
         $('#unit').append('<option value="' + cur['name'] + '">' + cur['name'] + '</option>');
       }
     }

     // Set selected default target currency select box
     console.log('Current Selecting Target Index: ' + selecting_target_index);
     if (selecting_target_index >= 0) {
       $('#config-target option[value="' + currencies[selecting_target_index] + '"]').prop('selected', true);
     }

     var rates = {};

     var refresh_currency = function(index) {
       console.log('Refreshing currency with index ' + index);
       if (index >= currencies.length) {
         console.log('Index out of range. finishing...');
         // save cache using cookie
         var json_data = JSON.stringify(currencies_cache);
         set_cookie('exchg', json_data, 60 * 60);
         return;
       }
       cur = currencies[index];
       if (cur['name'] == target_currency) {
         console.log('Index ' + index + ' is same with target_currency. Skipping...');
         refresh_currency(index+1);
         return;
       }

       exchg(cur['name'], target_currency, function(rate) {
         rates[cur['name']] = rate;
         var tmprate = point_round_2(rate);
         $('#exchanges_datas').append('<li>1 ' + cur['name'] + ' = ' + target_currency + ' ' + tmprate + ' (' + rate + ')</li>');
         refresh_currency(index+1);
       });
     }

     var refresh = function() {
       $('#exchanges_datas').html('');
       $('#postfix_calculator').html('to ' + target_currency);
       refresh_currency(0);
     };

     var results = [];

     var add_conversion = function() {
       var price = parseFloat($('#editor input[name="currency"]').val());
       if (price) {
         var unit = $('#unit option:selected').val();
         var rate = rates[unit];
         var result = point_round_2(price * rate);

         console.log('Price = ' + price + ', Unit = ' + unit + ', Rate = ' + rate + ', Result = ' + (price * rate));

         $('#results').append('<li>' + price + ' ' + unit + ' = ' + result + ' ' + target_currency + '</li>');
       }
       $('#editor input[name="currency"]').val('');
     };

     $(document).ready(function() {
       $('#remove_cookie_button').click(function() {
         console.log('Removing cookie...');
         expire_cookie('exchg');
       });

       refresh_cache();
       update_editor_select_box(true);
       refresh();
       $('#conversion_button').click(function() {
         add_conversion();
       });
       $('#currency_input').keypress(function(e) {
         if (e.which == 13) {
           add_conversion();
         }
       });
       $(document).on('change', '#config-target', function() {
         target_currency = $('#config-target option:selected').val();
         $('#exchanges_datas').html('');
         $('#results').html('');
         $('#unit').html('');
         $('#target-config').html('');
         update_editor_select_box(false);
         refresh();
       });
       $('#currency_input').focus();
     });
    </script>
  </body>
</html>
