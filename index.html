<html>
  <head>
    <script type="text/javascript" src="http://seorenn.github.io/js/jquery.min.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/exchg.js"></script>
  </head>
  <body>
    <div id="config">
      <form id="config-form">
      Target Currency
        <select id="config-target">
        </select>
        <!--<button type="button" id="remove_cookie_button">Remove Cookie</button>-->
      </form>
    </div>
    <div id="exchanges">
      <h2>Current Exchange Rates</h2>
      <ul id="exchanges_datas">
      </ul>
    </div>

    <div id="calculator">
      <h2>Exchange Rate Calculator</h2>
      <form id="editor" onsubmit="return false">
        <span class="calculator_text">Convert</span>
        <input type="text" name="currency" id="currency_input"/>
        <select id="unit" name="unit">
        </select>
        <span class="calculator_text" id="postfix_calculator"></span>
        <button type="button" id="conversion_button">Add Conversion</button>
      </form>
      <ul id="results">
      </ul>
    </div>

    <script type="text/javascript">
     var point_round_2 = function(value) {
       return Math.round(value * 100) / 100;
     };

     var rates = {};

     var target_currency = config_currencies[0].name;

     // build editor's currency data
     var selecting_target_index = -1;

     var save_cache = function() {
       var json = JSON.stringify(rates);
       set_cookie('exchg', json, 30*60);
     };
     var load_cache = function() {
       var json = get_cookie('exchg');
       if (!json) return false;

       var object = JSON.parse(json);
       if (!object) return false;

       rates = object

       return true;
     };
     var validate_cache = function() {
       var list = name_list_of_currencies(target_currency);
       var keys = Object.keys(rates);
       for (var i=0; i < list.length; i++) {
         var name = list[i];
         var key = name + target_currency;
         if (keys.indexOf(key) < 0) { return false; }
       }
       return true;
     };

     var update_editor_select_box = function(build_all) {
       if (build_all) {
         $('#config-target').html('');
       }

       // Build currencies select box for target and calculator
       for (var i=0; i < config_currencies.length; i++) {
         var cur = config_currencies[i];

         if (build_all) {
           $('#config-target').append('<option value="' + cur.name + '">' + cur.name + '</option>');
         }

         if (cur.name == target_currency) {
           selecting_target_index = i;
           continue;
         }
         $('#unit').append('<option value="' + cur.name + '">' + cur.name + '</option>');
       }
     }

     // Set selected default target currency select box
     console.log('Current Selecting Target Index: ' + selecting_target_index);
     if (selecting_target_index >= 0) {
       $('#config-target option[value="' + currencies[selecting_target_index] + '"]').prop('selected', true);
     }

     var make_ui = function(datas) {
       var keys = Object.keys(datas);
       for (var i=0; i < keys.length; i++) {
         var key = keys[i];
         var r = datas[key];
         var fromname = key.substring(0, 3);
         var toname = key.substring(3, 6);
         var ratedata = r.rate;
         $('#exchanges_datas').append('<li>1 ' + fromname + ' = ' + target_currency + ' ' + point_round_2(ratedata) + ' (' + ratedata + ')</li>');
       }
     };

     var refresh = function() {
       $('#exchanges_datas').html('');
       $('#postfix_calculator').html('to ' + target_currency);
       //refresh_currency(0);

       var fromlist = name_list_of_currencies(target_currency);
       exchg_yahoo_bulk(fromlist, target_currency, function(datas) {
         rates = datas;
         make_ui(datas);
         /*
         var keys = Object.keys(datas);
         for (var i=0; i < keys.length; i++) {
           var key = keys[i];
           var r = datas[key];
           var fromname = key.substring(0, 3);
           var toname = key.substring(3, 6);
           var ratedata = r.rate;
           $('#exchanges_datas').append('<li>1 ' + fromname + ' = ' + target_currency + ' ' + point_round_2(ratedata) + ' (' + ratedata + ')</li>');
         }
         */
         save_cache();
       });
     };

     var add_conversion = function() {
       var price = parseFloat($('#editor input[name="currency"]').val());
       if (price) {
         var unit = $('#unit option:selected').val();
         var key = unit + target_currency;
         var rateitem = rates[key];
         var result = point_round_2(price * rateitem.rate);

         console.log('Price = ' + price + ', Unit = ' + unit + ', Rate = ' + rateitem.rate + ', Result = ' + (price * rateitem.rate));

         $('#results').append('<li>' + price + ' ' + unit + ' = ' + result + ' ' + target_currency + '</li>');
       }
       $('#editor input[name="currency"]').val('');
     };

     $(document).ready(function() {
       update_editor_select_box(true);

       if (load_cache() && validate_cache()) {
         console.log('Build Datas with Cache');
         make_ui(rates);
       } else {
         console.log('Refreshing...');
         refresh();
       }

       $('#conversion_button').click(function() {
         add_conversion();
       });
       $('#currency_input').keypress(function(e) {
         if (e.which == 13) {
           add_conversion();
         }
       });
       $(document).on('change', '#config-target', function() {
         target_currency = $('#config-target option:selected').val();
         $('#exchanges_datas').html('');
         $('#results').html('');
         $('#unit').html('');
         $('#target-config').html('');
         update_editor_select_box(false);
         refresh();
       });
       $('#currency_input').focus();
     });
    </script>
  </body>
</html>
